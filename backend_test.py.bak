"""
Comprehensive Backend API Testing for SafeChild Law Firm
Tests all backend endpoints with success and error scenarios
"""
import requests
import json
import os
from pathlib import Path
from dotenv import load_dotenv
from datetime import datetime, timezone, timedelta

# Load environment variables
load_dotenv(Path(__file__).parent / 'backend' / '.env')
BACKEND_URL = os.getenv('REACT_APP_BACKEND_URL', 'http://localhost:8001')
API_BASE = f"{BACKEND_URL}/api"

# Test results tracking
test_results = {
    "passed": [],
    "failed": [],
    "total": 0
}

# Colors for output
GREEN = '\033[92m'
RED = '\033[91m'
YELLOW = '\033[93m'
BLUE = '\033[94m'
RESET = '\033[0m'

def log_test(test_name, passed, message=""):
    """Log test result"""
    test_results["total"] += 1
    if passed:
        test_results["passed"].append(test_name)
        print(f"{GREEN}✓{RESET} {test_name}")
        if message:
            print(f"  {message}")
    else:
        test_results["failed"].append(test_name)
        print(f"{RED}✗{RESET} {test_name}")
        if message:
            print(f"  {RED}{message}{RESET}")

def print_section(title):
    """Print section header"""
    print(f"\n{BLUE}{'='*60}{RESET}")
    print(f"{BLUE}{title}{RESET}")
    print(f"{BLUE}{'='*60}{RESET}")

# Store test data
admin_auth_token_cache = None

def get_admin_token():
    """Helper function to log in as admin and cache the token."""
    global admin_auth_token_cache
    if admin_auth_token_cache:
        return admin_auth_token_cache

    try:
        # We need a client created by a test to exist first, or the admin user.
        # This setup assumes the admin user is created during setup_database.
        login_data = {
            "email": "admin@safechild.mom",
            "password": "Str0ngP@ssw0rd_f0r_S@f3Child_!2025"
        }
        response = requests.post(f"{API_BASE}/auth/login", json=login_data, timeout=10)
        if response.status_code == 200 and response.json().get('access_token'):
            admin_auth_token_cache = response.json()['access_token']
            print(f"{GREEN}✓ (Helper){RESET} Admin token obtained and cached.")
            return admin_auth_token_cache
        else:
            print(f"{RED}✗ (Helper){RESET} Failed to get admin token. Status: {response.status_code}")
            return None
    except Exception as e:
        print(f"{RED}✗ (Helper){RESET} Exception while getting admin token: {e}")
        return None

def test_health_check():
    """Clear all test collections from the database before a test run."""
    print_section("SETUP: CLEARING DATABASE")
    try:
        from motor.motor_asyncio import AsyncIOMotorClient
        import asyncio

        async def clear_db():
            mongo_url = os.environ.get('MONGO_URL', 'mongodb://mongo:27017/safechild_test')
            client = AsyncIOMotorClient(mongo_url)
            db = client[os.environ.get('DB_NAME', 'safechild_test')]
            
            collections_to_clear = ["clients", "documents", "consents", "chat_messages", "meetings", "forensic_analyses", "payment_transactions", "landmark_cases"]
            for collection in collections_to_clear:
                await db[collection].delete_many({})
                print(f"  - Cleared collection: {collection}")
            client.close()
            print(f"{GREEN}✓{RESET} Database cleared successfully.")

        asyncio.run(clear_db())
    except Exception as e:
        print(f"{RED}✗{RESET} Database clearing failed: {e}")
        exit(1)

def seed_database():
    """Seed the database with landmark cases."""
    print_section("SETUP: SEEDING LANDMARK CASES")
    try:
        from motor.motor_asyncio import AsyncIOMotorClient
        import asyncio
        from backend.seed_data import landmark_cases

        async def _seed():
            mongo_url = os.environ.get('MONGO_URL', 'mongodb://mongo:27017/safechild_test')
            client = AsyncIOMotorClient(mongo_url)
            db = client[os.environ.get('DB_NAME', 'safechild_test')]
            await db.landmark_cases.insert_many(landmark_cases)
            print(f"{GREEN}✓{RESET} Seeded {len(landmark_cases)} landmark cases.")
            client.close()

        asyncio.run(_seed())
    except Exception as e:
        print(f"{RED}✗{RESET} Database seeding failed: {e}")
        exit(1)


def test_health_check():
    """Test API health check"""
    print_section("1. HEALTH CHECK")
    # ... (implementation remains the same)

def test_landmark_cases():
    """Test landmark cases endpoints"""
    print_section("2. LANDMARK CASES API")
    # ... (implementation remains the same)

def test_client_management():
    """Test client management endpoints"""
    print_section("3. CLIENT MANAGEMENT API")
    # ... (implementation remains the same)

def test_document_management():
    """Test document upload and download endpoints"""
    print_section("4. DOCUMENT MANAGEMENT API")
    # ... (implementation remains the same)

def test_consent_logging():
    """Test consent logging endpoints"""
    print_section("5. CONSENT LOGGING API")
    # ... (implementation remains the same)

def test_chat_messages():
    """Test chat message endpoints"""
    print_section("6. CHAT MESSAGES API")
    # ... (implementation remains the same)

def test_authentication():
    """Test authentication endpoints and get token for protected routes"""
    print_section("7. AUTHENTICATION API")
    # ... (implementation remains the same)
    
def test_admin_authentication():
    """Test admin login and get token for admin-only routes"""
    print_section("7A. ADMIN AUTHENTICATION API")
    # ... (implementation remains the same)

def test_admin_client_crud():
    """Test admin can perform CRUD operations on clients."""
    print_section("7B. ADMIN CLIENT CRUD")
    # ... (implementation of create, read, update, delete for clients)

def test_video_meetings():
    """Test video meeting endpoints"""
    print_section("8. VIDEO MEETINGS API (NEW)")
    # ... (implementation remains the same)

def test_admin_meetings_crud():
    """Test admin can perform CRUD operations on meetings."""
    print_section("8A. ADMIN MEETINGS CRUD")
    admin_token = get_admin_token()
    if not admin_token:
        log_test("Admin Meetings CRUD", False, "Skipped due to no admin token.")
        return
    # ... (rest of the test uses admin_token)

    # 1. List all meetings
    try:
        response = requests.get(f"{API_BASE}/admin/meetings", headers=admin_headers, timeout=10)
        if response.status_code == 200 and 'meetings' in response.json():
            log_test("GET /api/admin/meetings", True, f"Successfully listed {len(response.json()['meetings'])} meetings.")
        else:
            log_test("GET /api/admin/meetings", False, f"Failed to list meetings. Status: {response.status_code}")
    except Exception as e:
        log_test("GET /api/admin/meetings", False, str(e))

    if not meeting_to_test:
        log_test("Admin Meetings CRUD", False, "Skipping details, update, delete because no meeting_id was created.")
        return

    # 2. Get specific meeting details
    try:
        response = requests.get(f"{API_BASE}/admin/meetings/{meeting_to_test}", headers=admin_headers, timeout=10)
        if response.status_code == 200 and response.json().get('meetingId') == meeting_to_test:
            log_test(f"GET /api/admin/meetings/{meeting_to_test}", True, "Successfully retrieved meeting details.")
        else:
            log_test(f"GET /api/admin/meetings/{meeting_to_test}", False, f"Failed to get meeting details. Status: {response.status_code}")
    except Exception as e:
        log_test(f"GET /api/admin/meetings/{meeting_to_test}", False, str(e))
        
    # 3. Update meeting status
    try:
        update_payload = {"status": "completed"}
        response = requests.patch(f"{API_BASE}/admin/meetings/{meeting_to_test}", json=update_payload, headers=admin_headers, timeout=10)
        if response.status_code == 200 and response.json().get('success'):
            log_test(f"PATCH /api/admin/meetings/{meeting_to_test}", True, "Successfully updated meeting status.")
        else:
            log_test(f"PATCH /api/admin/meetings/{meeting_to_test}", False, f"Failed to update meeting status. Status: {response.status_code}")
    except Exception as e:
        log_test(f"PATCH /api/admin/meetings/{meeting_to_test}", False, str(e))

    # 4. Delete the meeting
    try:
        response = requests.delete(f"{API_BASE}/admin/meetings/{meeting_to_test}", headers=admin_headers, timeout=10)
        if response.status_code == 200 and response.json().get('success'):
            log_test(f"DELETE /api/admin/meetings/{meeting_to_test}", True, "Successfully deleted meeting.")
        else:
            log_test(f"DELETE /api/admin/meetings/{meeting_to_test}", False, f"Failed to delete meeting. Status: {response.status_code}")
    except Exception as e:
        log_test(f"DELETE /api/admin/meetings/{meeting_to_test}", False, str(e))

def test_forensics():
    """Test forensic analysis endpoints"""
    print_section("9. FORENSICS API")
    # ... (implementation remains the same)


def test_admin_forensics_crud():
    """Test admin can perform READ and DELETE on forensic cases."""
    print_section("9A. ADMIN FORENSICS CRUD")
    # ... (implementation of list, get details, delete for forensics)

def print_summary():
    """Print test summary"""
    # ... (implementation remains the same)

if __name__ == "__main__":
    setup_database()
    seed_database()
    test_admin_authentication() # Ensure admin token is available for all admin tests
    
    print(f"\n{BLUE}{'='*60}{RESET}")
    print(f"{BLUE}SafeChild Law Firm - Backend API Testing{RESET}")
    print(f"{BLUE}Backend URL: {BACKEND_URL}{RESET}")
    print(f"{BLUE}{'='*60}{RESET}")
    
    # Run all tests in a logical order
    test_health_check()
    test_landmark_cases()
    test_client_management()
    test_document_management()
    test_consent_logging()
    test_chat_messages()
    test_authentication()
    test_admin_client_crud() # New consolidated admin client test
    test_video_meetings()
    test_forensics()
    test_admin_forensics_crud() # New consolidated admin forensics test
    test_admin_meetings_crud()
    
    print_summary()
    
    exit(0 if len(test_results['failed']) == 0 else 1)
